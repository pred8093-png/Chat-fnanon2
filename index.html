<!doctype html>
<html lang="ar" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Private Space 💑</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo&display=swap');
    :root {
      --bg1: #0f0c29;
      --bg2: #302b63;
      --bg3: #24243e;
      --accent1: #ff6ec7;
      --accent2: #06b6d4;
      --text: #ffffff;
      --card-bg: rgba(255 255 255 / 0.05);
      --shadow-pink: rgba(255 110 199 / 0.3);
      --shadow-blue: rgba(6 182 212 / 0.3);
    }
    html, body {
      margin:0; padding:0; height:100%;
      font-family: 'Cairo', system-ui, Arial, sans-serif;
      background: radial-gradient(circle at 20% 20%, var(--bg1), var(--bg2), var(--bg3));
      overflow: hidden;
      color: var(--text);
      direction: rtl;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Animated gradient background */
    body::before {
      content: '';
      position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: linear-gradient(270deg, #302b63, #24243e, #0f0c29, #302b63);
      background-size: 800% 800%;
      animation: gradientBG 45s ease infinite;
      z-index: -2;
    }
    @keyframes gradientBG {
      0% {background-position:0% 50%;}
      50% {background-position:100% 50%;}
      100% {background-position:0% 50%;}
    }
    /* Canvas for stars and black hole */
    #spaceCanvas {
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      z-index: -1;
      pointer-events: none;
      user-select: none;
    }
    /* Container */
    .container {
      max-width: 980px;
      margin: 20px auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      box-shadow:
        0 0 30px var(--shadow-pink),
        0 0 40px var(--shadow-blue);
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow: hidden;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 24px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      user-select: text;
    }
    p {
      text-align: center;
      margin-bottom: 14px;
      color: rgba(255 255 255 / 0.7);
      user-select: text;
    }
    .chat {
      background: rgba(0 0 0 / 0.3);
      border-radius: 12px;
      padding: 12px;
      flex-grow: 1;
      overflow-y: auto;
      border: 1px solid rgba(255 255 255 / 0.08);
      backdrop-filter: blur(6px);
      user-select: text;
      scroll-behavior: smooth;
    }
    .bubble {
      margin: 6px 0;
      padding: 10px 12px;
      border-radius: 12px;
      max-width: 75%;
      word-break: break-word;
      box-shadow: 0 0 10px rgba(255 255 255 / 0.05);
      user-select: text;
    }
    .me {
      background: linear-gradient(90deg, #ff6ec7, #ff9a9e);
      margin-left: auto;
    }
    .them {
      background: linear-gradient(90deg, #06b6d4, #4facfe);
      margin-right: auto;
    }
    .meta {
      font-size: 12px;
      color: rgba(255 255 255 / 0.6);
      margin-bottom: 4px;
      user-select: text;
    }
    input, textarea, select, button {
      width: 100%;
      box-sizing: border-box;
      background: rgba(255 255 255 / 0.05);
      border: 1px solid rgba(255 255 255 / 0.1);
      padding: 10px;
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      user-select: text;
      font-family: 'Cairo', system-ui, Arial, sans-serif;
    }
    button {
      cursor: pointer;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      border: 0;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 0 12px rgba(255 110 199 / 0.4);
      transition: background 0.3s ease;
    }
    button:hover {
      background: linear-gradient(90deg, var(--accent2), var(--accent1));
    }
    .note {
      font-size: 12px;
      color: rgba(255 255 255 / 0.6);
      margin-top: 8px;
      user-select: text;
    }
    footer {
      margin-top: 14px;
      text-align: center;
      color: rgba(255 255 255 / 0.5);
      font-size: 12px;
      user-select: text;
    }
    .foot {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: nowrap;
    }
    #message {
      flex-grow: 1;
      min-width: 0;
    }
    /* Responsive adjustments */
    @media (max-width: 720px) {
      .container {
        padding: 10px;
        height: calc(100vh - 20px);
      }
      h1 {
        font-size: 20px;
      }
      .foot {
        flex-direction: column;
        gap: 6px;
      }
      button {
        width: 100%;
      }
      #message {
        min-width: 100%;
      }
      .chat {
        height: 280px;
      }
    }
  </style>
</head>
<body>
  <canvas id="spaceCanvas"></canvas>

  <div class="container" role="main">
    <div class="card" role="region" aria-label="منطقة الدردشة">
      <h1>Private Space 💑</h1>
      <p>مكانك الخاص للدردشة الآمنة تحت ظلال الفضاء ونبض الحب.</p>

      <div style="display:grid; gap:12px; margin-top:12px;">
        <div class="row" style="display:flex; gap:12px; flex-wrap: wrap;">
          <div class="col" style="flex-grow:1; min-width: 150px;">
            <label for="nick">الاسم (اختياري)</label>
            <input id="nick" name="nick" placeholder="اسم مثل: زائر أو اتركه فارغًا" autocomplete="off" />
          </div>
          <div style="width:140px;">
            <label for="anon">ابقَ متخفياً</label>
            <select id="anon" name="anon" autocomplete="off">
              <option value="false">ظاهر</option>
              <option value="true" selected>متخفٍ</option>
            </select>
          </div>
        </div>

        <div>
          <label for="passphrase">العبارة المشتركة (مفتاح التشفير)</label>
          <input id="passphrase" name="passphrase" placeholder="جملة أو كلمة سر مشتركة" autocomplete="off" />
          <div class="note">يُستخدم لاستخراج مفتاح AES عبر PBKDF2. شاركه خارج هذا الموقع.</div>
        </div>

        <div class="row" style="display:flex; gap:12px; flex-wrap: wrap;">
          <div class="col" style="flex-grow:1; min-width: 300px;">
            <label for="localSignal">إنشاء Offer — انسخه وابعثه للطرف الآخر</label>
            <textarea id="localSignal" readonly rows="5"></textarea>
            <div class="controls" style="margin-top:8px; display:flex; gap:6px;">
              <button id="createOffer" class="largeBtn" type="button">إنشاء Offer</button>
              <button id="copyOffer" class="muted-btn" type="button">نسخ</button>
            </div>
          </div>

          <div class="col" style="flex-grow:1; min-width: 300px;">
            <label for="remoteSignal">ألصق هنا العرض/الجواب من الطرف الآخر</label>
            <textarea id="remoteSignal" placeholder="الصق Offer أو Answer هنا" rows="5"></textarea>
            <div class="controls" style="margin-top:8px; display:flex; gap:6px;">
              <button id="acceptSignal" class="largeBtn" type="button">قبول</button>
              <button id="pasteRemote" class="muted-btn" type="button">لصق</button>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin-top: 8px;">
          <div style="flex:1; min-width: 150px;">
            <label for="status">حالة الاتصال</label>
            <input id="status" readonly value="غير متصل" />
          </div>
          <div style="width:200px;">
            <label for="encStatus">تشفير</label>
            <input id="encStatus" readonly value="غير مهيأ" />
          </div>
        </div>

        <div class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions"></div>

        <div class="foot">
          <input id="message" placeholder="اكتب رسالة..." autocomplete="off" />
          <button id="send" class="largeBtn" type="button">إرسال</button>
          <button id="clear" class="muted-btn" type="button">مسح</button>
        </div>

        <div class="note" style="font-size: 13px; line-height: 1.3; margin-top: 8px;">
          طريقة العمل:
          <ol style="margin:6px 0 0 18px; color: rgba(255 255 255 / 0.7); padding-left: 10px;">
            <li>افتح الملف على جهازين أو شاركه عبر GitHub Pages.</li>
            <li>خلق Offer ونسخه للطرف الآخر، ثم أكمل تبادل Offer/Answer.</li>
            <li>أدخل العبارة المشتركة نفسها على الطرفين ثم أرسل الرسائل.</li>
          </ol>
        </div>
      </div>

      <footer>صُمم للاستجابة والسهولة على شاشات اللمس — تمكين WebRTC وClipboard مطلوبان.</footer>
    </div>
  </div>

<script>
(() => {
  'use strict';

  // --- حفظ الاسم في LocalStorage ---
  const nickInput = document.getElementById('nick');
  const anonSelect = document.getElementById('anon');
  const passphraseInput = document.getElementById('passphrase');

  // استعادة الاسم والاختيارات
  window.addEventListener('load', () => {
    if(localStorage.getItem('nick')) nickInput.value = localStorage.getItem('nick');
    if(localStorage.getItem('anon')) anonSelect.value = localStorage.getItem('anon');
    if(localStorage.getItem('passphrase')) passphraseInput.value = localStorage.getItem('passphrase');
  });
  // حفظ تلقائي عند التغيير
  nickInput.addEventListener('input', () => localStorage.setItem('nick', nickInput.value));
  anonSelect.addEventListener('change', () => localStorage.setItem('anon', anonSelect.value));
  passphraseInput.addEventListener('input', () => localStorage.setItem('passphrase', passphraseInput.value));

  // --- WebRTC Chat Logic ---

  let pc, dc;
  let aesKey = null;

  const localSignal = document.getElementById('localSignal');
  const remoteSignal = document.getElementById('remoteSignal');
  const createOfferBtn = document.getElementById('createOffer');
  const acceptSignalBtn = document.getElementById('acceptSignal');
  const copyOfferBtn = document.getElementById('copyOffer');
  const pasteRemoteBtn = document.getElementById('pasteRemote');
  const status = document.getElementById('status');
  const encStatus = document.getElementById('encStatus');
  const chat = document.getElementById('chat');
  const sendBtn = document.getElementById('send');
  const messageInput = document.getElementById('message');

  // --- Clipboard fallback ---
  async function writeClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      } catch {
        return false;
      }
    }
  }
  async function readClipboard() {
    try {
      return await navigator.clipboard.readText();
    } catch {
      return '';
    }
  }

  // --- Crypto: derive AES key from passphrase ---
  async function deriveKey(pass) {
    setEnc('قيد الإنشاء...');
    const enc = new TextEncoder().encode(pass);
    const salt = new TextEncoder().encode('chat-salt-v1');
    const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({
      name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256'
    }, baseKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
    setEnc('مُهيأ');
    return key;
  }

  // --- Setup WebRTC PeerConnection ---
  function setupPeer(isOffer) {
    pc = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] });
    pc.oniceconnectionstatechange = () => setStatus(pc.iceConnectionState);
    pc.onicecandidate = e => {
      if (!e.candidate) localSignal.value = JSON.stringify(pc.localDescription);
    };
    pc.ondatachannel = e => { dc = e.channel; initDC(); };
    if (isOffer) {
      dc = pc.createDataChannel('chat');
      initDC();
    }
  }
  // --- DataChannel init ---
  function initDC() {
    dc.onopen = () => setStatus('قناة مفتوحة');
    dc.onclose = () => setStatus('مغلقة');
    dc.onmessage = async e => {
      try {
        const obj = JSON.parse(e.data);
        if (obj.type === 'msg') {
          const plaintext = await decryptMessage(obj.payload);
          logBubble(plaintext, 'them');
          vibrateNotification();
          playNotificationSound();
        }
      } catch (err) { console.error(err); }
    };
  }
  // --- Encrypt message ---
  async function encryptMessage(text) {
    if (!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = new TextEncoder().encode(text);
    const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, aesKey, enc);
    return JSON.stringify({ iv: Array.from(iv), ct: Array.from(new Uint8Array(ct)) });
  }
  // --- Decrypt message ---
  async function decryptMessage(payload) {
    if (!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
    const iv = new Uint8Array(payload.iv);
    const ct = new Uint8Array(payload.ct);
    const plain = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, ct);
    return new TextDecoder().decode(plain);
  }

  // --- UI updates ---
  function logBubble(text, who = 'them') {
    const b = document.createElement('div');
    b.className = 'bubble ' + (who === 'me' ? 'me' : 'them');
    const meta = document.createElement('div'); meta.className = 'meta';
    meta.textContent = who === 'me' ? (nickInput.value || 'متخفٍ') : 'الطرف الآخر';
    b.appendChild(meta);
    const t = document.createElement('div'); t.textContent = text; b.appendChild(t);
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
  }
  function setStatus(s) { status.value = s; }
  function setEnc(s) { encStatus.value = s; }

  // --- Notification: vibration &
