index.html
index.html
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>دردشة مشفّرة — فضاء، موسيقى، حب</title>
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, #0f0c29, #302b63, #24243e);
      --card: rgba(255,255,255,0.05);
      --accent: #ff6ec7;
      --accent2: #06b6d4;
      --muted: #b8b8d1;
      --text: #ffffff;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: 'Cairo', system-ui, Arial;
      direction:rtl;
      background: var(--bg);
      color:var(--text);
      background-attachment: fixed;
      animation: bgMove 30s infinite alternate ease-in-out;
    }
    @keyframes bgMove {
      0% {background-position: 0 0;}
      100% {background-position: 100% 100%;}
    }
    .container{max-width:980px;margin:20px auto;padding:16px}
    .card{
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius:20px;
      padding:20px;
      box-shadow: 0 0 30px rgba(255,110,199,0.2);
    }
    h1{
      margin:0 0 8px;
      font-size:22px;
      background: linear-gradient(90deg,var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align:center;
    }
    p{text-align:center;margin-bottom:14px;color:var(--muted)}
    .chat{
      height:360px;overflow:auto;border-radius:12px;padding:12px;
      background: rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
    }
    .bubble{
      margin:6px 0;padding:10px 12px;border-radius:12px;max-width:75%;word-break:break-word;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
    }
    .me{
      background: linear-gradient(90deg,#ff6ec7,#ff9a9e);
      margin-left:auto;
    }
    .them{
      background: linear-gradient(90deg,#06b6d4,#4facfe);
      margin-right:auto;
    }
    .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select,button{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      padding:10px;border-radius:8px;color:var(--text);font-size:14px;
    }
    button{
      cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent2));
      border:0;color:#fff;font-weight:600;
      box-shadow: 0 0 12px rgba(255,110,199,0.4);
    }
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
    @media(max-width:720px){
      .container{padding:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>💫 دردشة مشفّرة — فضاء × موسيقى × حب 💖</h1>
      <p>مكانك الآمن للبوح تحت نجوم الفضاء وإيقاعات الموسيقى ونبض الحب.</p>
      <!-- باقي الكود البرمجي (HTML + JS) كما هو في النسخة السابقة -->
    </div>
  </div>
</body>
</html>index.html
<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>دردشة مشفّرة — فضاء، موسيقى، حب</title>
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, #0f0c29, #302b63, #24243e);
      --card: rgba(255,255,255,0.05);
      --accent: #ff6ec7;
      --accent2: #06b6d4;
      --muted: #b8b8d1;
      --text: #ffffff;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: 'Cairo', system-ui, Arial;
      direction:rtl;
      background: var(--bg);
      color:var(--text);
      background-attachment: fixed;
      animation: bgMove 30s infinite alternate ease-in-out;
    }
    @keyframes bgMove {
      0% {background-position: 0 0;}
      100% {background-position: 100% 100%;}
    }
    .container{max-width:980px;margin:20px auto;padding:16px}
    .card{
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius:20px;
      padding:20px;
      box-shadow: 0 0 30px rgba(255,110,199,0.2);
    }
    h1{
      margin:0 0 8px;
      font-size:22px;
      background: linear-gradient(90deg,var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align:center;
    }
    p{text-align:center;margin-bottom:14px;color:var(--muted)}
    .chat{
      height:360px;overflow:auto;border-radius:12px;padding:12px;
      background: rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
    }
    .bubble{
      margin:6px 0;padding:10px 12px;border-radius:12px;max-width:75%;word-break:break-word;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
    }
    .me{
      background: linear-gradient(90deg,#ff6ec7,#ff9a9e);
      margin-left:auto;
    }
    .them{
      background: linear-gradient(90deg,#06b6d4,#4facfe);
      margin-right:auto;
    }
    .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select,button{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      padding:10px;border-radius:8px;color:var(--text);font-size:14px;
    }
    button{
      cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent2));
      border:0;color:#fff;font-weight:600;
      box-shadow: 0 0 12px rgba(255,110,199,0.4);
    }
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
    @media(max-width:720px){
      .container{padding:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>💫 دردشة مشفّرة — فضاء × موسيقى × حب 💖</h1>
      <p>مكانك الآمن للبوح تحت نجوم الفضاء وإيقاعات الموسيقى ونبض الحب.</p>
      <!-- باقي الكود البرمجي (HTML + JS) كما هو في النسخة السابقة -->
    </div>
  </div>
</body>
</html>
نسخة محسّنة للأندرويد: أزرار أكبر، نسخ/لصق احتياطي، ورسائل خطأ واضحة.</p>

      <div style="display:grid;gap:12px;margin-top:12px">
        <div class="row">
          <div class="col">
            <label>الاسم (اختياري)</label>
            <input id="nick" placeholder="اسم مثل: زائر أو اتركه فارغًا" />
          </div>
          <div style="width:140px">
            <label>ابقَ متخفياً</label>
            <select id="anon">
              <option value="false">ظاهر</option>
              <option value="true" selected>متخفٍّ</option>
            </select>
          </div>
        </div>

        <div>
          <label>العبارة المشتركة (مفتاح)</label>
          <input id="passphrase" placeholder="جملة أو كلمة سر مشتركة" />
          <div class="note">يُستخدم لاستخراج مفتاح AES عبر PBKDF2. شاركه خارج هذا الموقع.</div>
        </div>

        <div class="row">
          <div class="col">
            <label>إنشاء Offer — انسخه وابعثه للطرف الآخر</label>
            <textarea id="localSignal" readonly></textarea>
            <div class="controls" style="margin-top:8px">
              <button id="createOffer" class="largeBtn">إنشاء Offer</button>
              <button id="copyOffer" class="muted-btn">نسخ</button>
            </div>
          </div>

          <div class="col">
            <label>ألصق هنا العرض/الجواب من الطرف الآخر</label>
            <textarea id="remoteSignal" placeholder="الصق Offer أو Answer هنا"></textarea>
            <div class="controls" style="margin-top:8px">
              <button id="acceptSignal" class="largeBtn">قبول</button>
              <button id="pasteRemote" class="muted-btn">لصق</button>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label>حالة الاتصال</label>
            <input id="status" readonly value="غير متصل" />
          </div>
          <div style="width:200px">
            <label>تشفير</label>
            <input id="encStatus" readonly value="غير مهيأ" />
          </div>
        </div>

        <div class="chat" id="chat"></div>

        <div class="foot" style="display:flex;gap:8px;margin-top:8px">
          <input id="message" placeholder="اكتب رسالة..." />
          <button id="send" class="largeBtn">إرسال</button>
          <button id="clear" class="muted-btn">مسح</button>
        </div>

        <div class="note">طريقة العمل:
          <ol style="margin:6px 0 0 18px;color:var(--muted)">
            <li>افتح الملف على جهازين أو شاركه عبر GitHub Pages.</li>
            <li>خلق Offer ونسخه للطرف الآخر، ثم اكمل تبادل Offer/Answer.</li>
            <li>أدخل العبارة المشتركة نفسها على الطرفين ثم أرسل الرسائل.</li>
          </ol>
        </div>
      </div>

      <footer>صُمم للاستجابة والسهولة على شاشات اللمس — تمكين WebRTC وClipboard مطلوبان.</footer>
    </div>
  </div>

<script>
// نسخة محسّنة لاستخدمات الأندرويد: دعم Clipboard احتياطي، رسائل خطأ أوضح
let pc, dc; let aesKey = null;
const localSignal = document.getElementById('localSignal');
const remoteSignal = document.getElementById('remoteSignal');
const createOfferBtn = document.getElementById('createOffer');
const acceptSignalBtn = document.getElementById('acceptSignal');
const copyOfferBtn = document.getElementById('copyOffer');
const pasteRemoteBtn = document.getElementById('pasteRemote');
const status = document.getElementById('status');
const encStatus = document.getElementById('encStatus');
const chat = document.getElementById('chat');
const sendBtn = document.getElementById('send');
const messageInput = document.getElementById('message');
const clearBtn = document.getElementById('clear');
const passphraseInput = document.getElementById('passphrase');

function logBubble(text,who='them'){
  const b = document.createElement('div');
  b.className = 'bubble '+(who==='me'?'me':'them');
  const meta = document.createElement('div'); meta.className='meta';
  meta.textContent = who==='me' ? (document.getElementById('nick').value||'متخفٍ') : 'الطرف الآخر';
  b.appendChild(meta);
  const t = document.createElement('div'); t.textContent = text; b.appendChild(t);
  chat.appendChild(b);
  chat.scrollTop = chat.scrollHeight;
}

function setStatus(s){ status.value = s }
function setEnc(s){ encStatus.value = s }

// Clipboard helper: يحاول API الجديد، وإذا فشل يستخدم الحيلة القديمة
async function writeClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }
  catch(e){
    // fallback: create temporary textarea and execCommand (works على بعض المتصفحات)
    try{
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
      ta.select(); ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand('copy'); document.body.removeChild(ta); return ok;
    }catch(err){ console.warn('clipboard fallback failed', err); return false; }
  }
}

async function readClipboard(){
  try{ return await navigator.clipboard.readText(); }
  catch(e){
    // لا يوجد fallback آمن للقراءة من الحافظة في بعض المتصفحات
    return '';
  }
}

async function deriveKey(pass){
  setEnc('قيد الإنشاء...');
  const enc = new TextEncoder().encode(pass);
  const salt = new TextEncoder().encode('chat-salt-v1');
  const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey({name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'}, baseKey, {name:'AES-GCM',length:256}, false, ['encrypt','decrypt']);
  setEnc('مُهيأ');
  return key;
}

function setupPeer(isOffer){
  pc = new RTCPeerConnection({iceServers:[{urls:['stun:stun.l.google.com:19302']}]});
  pc.oniceconnectionstatechange = ()=> setStatus(pc.iceConnectionState);
  pc.onicecandidate = e => { if(!e.candidate) localSignal.value = JSON.stringify(pc.localDescription); }
  pc.ondatachannel = e=>{ dc = e.channel; initDC(); }
  if(isOffer){ dc = pc.createDataChannel('chat'); initDC(); }
}

function initDC(){
  dc.onopen = ()=> setStatus('قناة مفتوحة');
  dc.onclose = ()=> setStatus('مغلقة');
  dc.onmessage = async (e)=>{
    try{
      const obj = JSON.parse(e.data);
      if(obj.type==='msg'){
        const plaintext = await decryptMessage(obj.payload);
        logBubble(plaintext,'them');
      }
    }catch(err){console.error(err)}
  }
}

async function encryptMessage(text){ if(!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder().encode(text);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, aesKey, enc);
  return JSON.stringify({iv:Array.from(iv),ct:Array.from(new Uint8Array(ct))});
}

async function decryptMessage(payload){ if(!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
  const obj = payload;
  const iv = new Uint8Array(obj.iv);
  const ct = new Uint8Array(obj.ct);
  const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, aesKey, ct);
  return new TextDecoder().decode(plain);
}

createOfferBtn.onclick = async ()=>{
  try{
    setupPeer(true);
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    setStatus('انشاء Offer...');
  }catch(err){ alert('خطأ عند إنشاء Offer: '+err.message) }
}

acceptSignalBtn.onclick = async ()=>{
  const text = remoteSignal.value.trim(); if(!text) return alert('ألصق العرض أو الجواب أولاً');
  let obj; try{ obj = JSON.parse(text); }catch(e){ return alert('نص الإشارة غير صالح JSON'); }
  if(obj.type === 'offer'){
    try{
      setupPeer(false);
      await pc.setRemoteDescription(obj);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      localSignal.value = JSON.stringify(pc.localDescription);
      setStatus('تم إنشاء Answer — أرسله للطرف الأول');
    }catch(err){ alert('خطأ في استقبال العرض: '+err.message) }
  } else if(obj.type === 'answer'){
    try{ if(!pc) setupPeer(true); await pc.setRemoteDescription(obj); setStatus('Answer مقبول — في إنتظار القناة'); }
    catch(err){ alert('فشل قبول Answer: '+err.message) }
  } else { alert('نوع الإشارة غير معروف'); }
}

copyOfferBtn.onclick = async ()=>{
  if(!localSignal.value) return alert('لا يوجد عرض للنسخ');
  const ok = await writeClipboard(localSignal.value);
  if(ok) alert('نُسخ إلى الحافظة'); else alert('فشل النسخ — انسخ يدوياً');
}

pasteRemoteBtn.onclick = async ()=>{
  const txt = await readClipboard();
  if(txt) remoteSignal.value = txt; else alert('فشل قراءة الحافظة — الصق يدوياً');
}

sendBtn.onclick = async ()=>{
  const txt = messageInput.value.trim(); if(!txt) return;
  if(!dc || dc.readyState!=='open') return alert('القناة غير مفتوحة');
  try{
    if(!aesKey){ const pass = passphraseInput.value; if(!pass) return alert('أدخل العبارة المشتركة'); aesKey = await deriveKey(pass); }
    const encrypted = await encryptMessage(txt);
    dc.send(JSON.stringify({type:'msg',payload:JSON.parse(encrypted)}));
    logBubble(txt,'me'); messageInput.value = '';
  }catch(err){ alert('خطأ في الإرسال: '+err.message); console.error(err) }
}

clearBtn.onclick = ()=>{ chat.innerHTML=''; }
messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendBtn.click(); } });

// فحص مبسّط عند التحميل لظهور رسائل توضيحية للأندرويد
window.addEventListener('load', ()=>{
  // تأكد من دعم WebRTC
  if(!window.RTCPeerConnection){ setStatus('WebRTC غير مدعوم في هذا المتصفح'); }
  // توضيح لClipboard
  if(!navigator.clipboard){ console.warn('Clipboard API غير متاح'); }
});
</script>

</body>
</html>
