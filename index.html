<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Private Space 👩‍❤️‍👨 — دردشة مشفّرة مع سيرفر إشارات</title>
  <style>
    :root{
      --bg: radial-gradient(circle at 20% 20%, #0f0c29, #302b63, #24243e);
      --card: rgba(255,255,255,0.05);
      --accent: #ff6ec7;
      --accent2: #06b6d4;
      --muted: #b8b8d1;
      --text: #ffffff;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: 'Cairo', system-ui, Arial;
      direction:rtl;
      background: var(--bg);
      color:var(--text);
      background-attachment: fixed;
      animation: bgMove 30s infinite alternate ease-in-out;
    }
    @keyframes bgMove {
      0% {background-position: 0 0;}
      100% {background-position: 100% 100%;}
    }
    .container{max-width:980px;margin:20px auto;padding:16px}
    .card{
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius:20px;
      padding:20px;
      box-shadow: 0 0 30px rgba(255,110,199,0.2);
    }
    h1{
      margin:0 0 8px;
      font-size:22px;
      background: linear-gradient(90deg,var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align:center;
    }
    p{text-align:center;margin-bottom:14px;color:var(--muted)}
    .chat{
      height:360px;overflow:auto;border-radius:12px;padding:12px;
      background: rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
      margin-top:12px;
    }
    .bubble{
      margin:6px 0;padding:10px 12px;border-radius:12px;max-width:75%;word-break:break-word;
      box-shadow: 0 0 10px rgba(255,255,255,0.05);
    }
    .me{
      background: linear-gradient(90deg,#ff6ec7,#ff9a9e);
      margin-left:auto;
    }
    .them{
      background: linear-gradient(90deg,#06b6d4,#4facfe);
      margin-right:auto;
    }
    .meta{font-size:12px;color:var(--muted);margin-bottom:4px}
    input,textarea,select,button{
      width:100%;box-sizing:border-box;background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      padding:10px;border-radius:8px;color:var(--text);font-size:14px;
    }
    button{
      cursor:pointer;background:linear-gradient(90deg,var(--accent),var(--accent2));
      border:0;color:#fff;font-weight:600;
      box-shadow: 0 0 12px rgba(255,110,199,0.4);
    }
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:12px}
    @media(max-width:720px){
      .container{padding:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Private Space 👩‍❤️‍👨</h1>
      <p>مكانك الآمن للبوح تحت نجوم الفضاء وإيقاعات الموسيقى ونبض الحب.</p>

      <div>
        <label>الاسم (اختياري)</label>
        <input id="nick" placeholder="اسم مثل: زائر أو اتركه فارغًا" />
      </div>
      <div style="margin-top:8px">
        <label>ابقَ متخفياً</label>
        <select id="anon">
          <option value="false">ظاهر</option>
          <option value="true" selected>متخفٍّ</option>
        </select>
      </div>
      <div style="margin-top:8px">
        <label>العبارة المشتركة (مفتاح التشفير)</label>
        <input id="passphrase" placeholder="جملة أو كلمة سر مشتركة" />
        <div class="note">يُستخدم لاستخراج مفتاح AES عبر PBKDF2. شاركه خارج هذا الموقع.</div>
      </div>

      <div style="margin-top:12px">
        <label>حالة الاتصال</label>
        <input id="status" readonly value="غير متصل" />
      </div>
      <div style="margin-top:8px">
        <label>تشفير</label>
        <input id="encStatus" readonly value="غير مهيأ" />
      </div>

      <div class="chat" id="chat"></div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <input id="message" placeholder="اكتب رسالة..." style="flex:1" />
        <button id="send">إرسال</button>
        <button id="clear" class="muted-btn">مسح</button>
      </div>

      <div class="note" style="margin-top:12px">
        طريقة العمل:
        <ol style="margin:6px 0 0 18px;color:var(--muted)">
          <li>افتح الموقع على جهازين أو شاركه عبر GitHub Pages.</li>
          <li>سيتم التوصيل تلقائيًا عبر سيرفر الإشارات.</li>
          <li>أدخل العبارة المشتركة نفسها على الطرفين ثم ابدأ بالدردشة.</li>
        </ol>
      </div>

      <footer>صُمم للاستجابة والسهولة على شاشات اللمس — تمكين WebRTC وClipboard مطلوبان.</footer>
    </div>
  </div>

<script>
  let pc, dc;
  let aesKey = null;
  let ws;
  const serverUrl = "wss://signaling.simplewebrtc.com"; // سيرفر إشارات عام مفتوح. يمكنك تغييره لسيرفرك الخاص.

  const nickInput = document.getElementById('nick');
  const anonSelect = document.getElementById('anon');
  const passphraseInput = document.getElementById('passphrase');
  const status = document.getElementById('status');
  const encStatus = document.getElementById('encStatus');
  const chat = document.getElementById('chat');
  const messageInput = document.getElementById('message');
  const sendBtn = document.getElementById('send');
  const clearBtn = document.getElementById('clear');

  // إضافة رسالة في الدردشة
  function logBubble(text, who='them'){
    const b = document.createElement('div');
    b.className = 'bubble '+(who==='me'?'me':'them');
    const meta = document.createElement('div'); 
    meta.className='meta';
    meta.textContent = who==='me' ? (nickInput.value || 'متخفٍ') : 'الطرف الآخر';
    b.appendChild(meta);
    const t = document.createElement('div'); 
    t.textContent = text; 
    b.appendChild(t);
    chat.appendChild(b);
    chat.scrollTop = chat.scrollHeight;
  }

  // تحديث حالة الاتصال
  function setStatus(s){ status.value = s; }
  function setEnc(s){ encStatus.value = s; }

  // توليد مفتاح AES من العبارة المشتركة
  async function deriveKey(pass){
    setEnc('قيد الإنشاء...');
    const enc = new TextEncoder().encode(pass);
    const salt = new TextEncoder().encode('chat-salt-v1');
    const baseKey = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey(
      {name:'PBKDF2',salt:salt,iterations:100000,hash:'SHA-256'}, 
      baseKey, 
      {name:'AES-GCM',length:256}, 
      false, 
      ['encrypt','decrypt']
    );
    setEnc('مُهيأ');
    return key;
  }

  // إعداد اتصال WebRTC
  function setupPeer(isOffer){
    pc = new RTCPeerConnection({iceServers:[{urls:['stun:stun.l.google.com:19302']}]});
    pc.oniceconnectionstatechange = ()=> setStatus(pc.iceConnectionState);
    pc.onicecandidate = e => {
      if(e.candidate) return;
      // عند الانتهاء من جمع ICE, أرسل الوصف المحلي عبر WS
      sendSignal({type: 'signal', data: pc.localDescription});
    };
    if(isOffer){
      dc = pc.createDataChannel('chat');
      initDC();
    }
    pc.ondatachannel = e=>{
      dc = e.channel;
      initDC();
    }
  }

  // إعداد قناة البيانات
  function initDC(){
    dc.onopen = ()=> setStatus('قناة مفتوحة');
    dc.onclose = ()=> setStatus('مغلقة');
    dc.onmessage = async (e)=>{
      try{
        const obj = JSON.parse(e.data);
        if(obj.type==='msg'){
          const plaintext = await decryptMessage(obj.payload);
          logBubble(plaintext,'them');
        }
      }catch(err){console.error(err)}
    }
  }

  // تشفير رسالة
  async function encryptMessage(text){ 
    if(!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = new TextEncoder().encode(text);
    const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, aesKey, enc);
    return JSON.stringify({iv:Array.from(iv),ct:Array.from(new Uint8Array(ct))});
  }

  // فك التشفير
  async function decryptMessage(payload){ 
    if(!aesKey) throw new Error('مفتاح التشفير غير مُهيأ');
    const obj = payload;
    const iv = new Uint8Array(obj.iv);
    const ct = new Uint8Array(obj.ct);
    const plain = await crypto.subtle.decrypt({name:'AES-GCM',iv}, aesKey, ct);
    return new TextDecoder().decode(plain);
  }

  // إرسال رسالة عبر WebSocket سيرفر الإشارات
  function sendSignal(message){
    if(ws && ws.readyState === WebSocket.OPEN){
      ws.send(JSON.stringify(message));
    }
  }

  // استقبال رسائل WebSocket
  function handleSignal(data){
    if(data.type === 'signal'){
      const desc = data.data;
      if(desc.type === 'offer'){
        setupPeer(false);
        pc.setRemoteDescription(desc).then(()=>{
          return pc.createAnswer();
        }).then(answer=>{
          return pc.setLocalDescription(answer);
        }).then(()=>{
          sendSignal({type:'signal', data: pc.localDescription});
          setStatus('تم إرسال Answer');
        }).catch(console.error);
      } else if(desc.type === 'answer'){
        pc.setRemoteDescription(desc).catch(console.error);
        setStatus('تم قبول Answer');
      }
    } else if(data.type === 'ice-candidate'){
      if(pc){
        pc.addIceCandidate(data.candidate).catch(console.error);
      }
    }
  }

  // بدء الاتصال بسيرفر الإشارات
  function startWebSocket(){
    ws = new WebSocket(serverUrl);

    ws.onopen = () => {
      setStatus('متصل بسيرفر الإشارات');
      // الطرف الأول يبدأ بإنشاء offer
      setupPeer(true);
      pc.createOffer().then(offer=>{
        return pc.setLocalDescription(offer);
      }).catch(console.error);
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        handleSignal(data);
      } catch (e) {
        console.error('خطأ في معالجة إشارة:', e);
      }
    };

    ws.onerror = (e) => {
      setStatus('خطأ في اتصال سيرفر الإشارات');
      console.error('WebSocket error:', e);
    };

    ws.onclose = () => {
      setStatus('انقطع اتصال سيرفر الإشارات');
    };
  }

  // إرسال رسالة مشفرة عبر قناة البيانات
  sendBtn.onclick = async () => {
    const txt = messageInput.value.trim();
    if(!txt) return;
    if(!dc || dc.readyState !== 'open') return alert('القناة غير مفتوحة');
    try {
      if(!aesKey){ 
        const pass = passphraseInput.value; 
        if(!pass) return alert('أدخل العبارة المشتركة'); 
        aesKey = await deriveKey(pass); 
      }
      const encrypted = await encryptMessage(txt);
      dc.send(JSON.stringify({type:'msg',payload:JSON.parse(encrypted)}));
      logBubble(txt,'me');
      messageInput.value = '';
    } catch(err) {
      alert('خطأ في الإرسال: '+err.message);
      console.error(err);
    }
  };

  clearBtn.onclick = () => { chat.innerHTML = ''; };

  messageInput.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); sendBtn.click(); } });

  window.addEventListener('load', () => {
    if(!window.RTCPeerConnection){ setStatus('WebRTC غير مدعوم في هذا المتصفح'); }
    if(!navigator.clipboard){ console.warn('Clipboard API غير متاح'); }
    startWebSocket();
  });
</script>

</body>
</html>
